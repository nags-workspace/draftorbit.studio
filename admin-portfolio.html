<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="assets/images/logo.png">
    <title>Portfolio Management - DraftOrbit Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container"><a class="navbar-brand fw-bold" href="admin.html">DraftOrbit Admin</a><a href="admin.html" class="btn btn-outline-secondary">Back to Dashboard</a></div>
    </nav>
    <main class="container py-5">
        <h1 class="fw-bold mb-4">Add New Portfolio Item</h1>
        <div class="alert alert-info">
            <strong>Instructions:</strong> Fill out all fields, choose an image from your computer, and click "Add & Deploy". The image will be automatically uploaded and your portfolio will be updated.
        </div>
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-12"><label for="proj-title" class="form-label">Project Title</label><input type="text" id="proj-title" class="form-control"></div>
                    <div class="col-md-12"><label for="proj-desc" class="form-label">Project Description</label><textarea id="proj-desc" class="form-control" rows="3"></textarea></div>
                    <div class="col-md-12"><label for="proj-image" class="form-label">Upload Image</label><input type="file" id="proj-image" class="form-control" accept="image/jpeg, image/png, image/webp"></div>
                </div>
                <div class="d-grid mt-4">
                    <button id="add-and-deploy-button" class="btn btn-success btn-lg">Add & Deploy to Website</button>
                </div>
                <div id="admin-alert" class="alert d-none mt-3"></div>
            </div>
        </div>
    </main>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwMnmfB_77LKLb4-XeWUmvCAAdPB9gwWd6kllLXqo2A3s5IRLddoyt_j_CP2mBFRB0/exec";

            const titleInput = document.getElementById('proj-title');
            const descInput = document.getElementById('proj-desc');
            const imageInput = document.getElementById('proj-image');
            const deployButton = document.getElementById('add-and-deploy-button');
            const adminAlert = document.getElementById('admin-alert');

            function showAlert(message, type = 'info') {
                adminAlert.textContent = message;
                adminAlert.className = `alert alert-${type} mt-3`;
                adminAlert.classList.remove('d-none');
            }

            deployButton.addEventListener('click', () => {
                const file = imageInput.files[0];
                if (!file || !titleInput.value.trim() || !descInput.value.trim()) {
                    alert("Please fill out all fields and select an image.");
                    return;
                }

                deployButton.disabled = true;
                deployButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Uploading & Deploying...';
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    const fileData = {
                        fileName: file.name.replace(/\s/g, '-'), // Sanitize filename
                        mimeType: file.type,
                        file: event.target.result, // This is the Base64 encoded file data
                        title: titleInput.value.trim(),
                        description: descInput.value.trim()
                    };
                    
                    fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify(fileData)
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.result === 'success') {
                            showAlert("Deployment successful! Your portfolio will be live in 1-2 minutes.", 'success');
                            titleInput.value = '';
                            descInput.value = '';
                            imageInput.value = '';
                        } else {
                            throw new Error(data.message || 'Unknown error from the deployment script.');
                        }
                    })
                    .catch(error => {
                        console.error("Error deploying:", error);
                        showAlert(`Deployment failed: ${error.message}`, 'danger');
                    })
                    .finally(() => {
                        deployButton.disabled = false;
                        deployButton.innerHTML = 'Add & Deploy to Website';
                    });
                };
                
                reader.readAsDataURL(file); // Read the file as a Base64 string
            });
        });
    </script>
</body>
</html>