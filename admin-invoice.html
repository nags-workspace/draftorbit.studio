<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="assets/images/logo.png">
    <title>Edit Invoice - DraftOrbit Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <nav class="navbar navbar-dark bg-dark">
        <div class="container"><a class="navbar-brand fw-bold" href="admin.html">DraftOrbit Admin</a></div>
    </nav>

    <main class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="fw-bold mb-0">Edit Invoice</h1>
                    <a href="admin.html" class="btn btn-secondary">Back to Dashboard</a>
                </div>
                <div id="loading-state" class="text-center"><div class="spinner-border"></div></div>
                <div id="invoice-editor-container" class="card border-0 shadow-sm d-none">
                    <div class="card-body p-4">
                        <div class="row mb-3">
                            <div class="col">
                                <h6 class="text-muted">Project: <span id="project-name" class="fw-bold"></span></h6>
                            </div>
                             <div class="col text-end">
                                <h6 class="text-muted">User: <span id="user-name" class="fw-bold"></span></h6>
                            </div>
                        </div>
                        <table class="table align-middle">
                            <thead><tr><th>Description</th><th style="width: 150px;">Amount (₹)</th></tr></thead>
                            <tbody>
                                <tr>
                                    <td>Quoted Price (from instant quote)</td>
                                    <td><input type="number" id="quoted-price" class="form-control" readonly></td>
                                </tr>
                                <tr>
                                    <td><input type="text" id="extra-desc" class="form-control" placeholder="e.g., Shipping & Handling"></td>
                                    <td><input type="number" id="extra-amount" class="form-control" value="0"></td>
                                </tr>
                                <tr>
                                    <td><input type="text" id="discount-desc" class="form-control" placeholder="e.g., New Customer Discount"></td>
                                    <td><input type="number" id="discount-amount" class="form-control" value="0" placeholder="Enter as a negative number"></td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th class="text-end">Final Total:</th>
                                    <th class="fs-4 text-primary" id="final-total">₹0.00</th>
                                </tr>
                            </tfoot>
                        </table>
                        <div class="mt-3">
                             <label for="invoice-notes" class="form-label">Notes for Customer</label>
                             <textarea id="invoice-notes" class="form-control" rows="3" placeholder="e.g., Payment instructions, thank you message..."></textarea>
                        </div>
                        <div class="d-grid mt-4">
                            <button id="save-invoice-button" class="btn btn-success btn-lg">Save & Enable Invoice for Customer</button>
                        </div>
                        <div id="admin-alert" class="alert d-none mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
  apiKey: "AIzaSyBEb1sB_AXKGxam3si8m81LPgr3b8HXTvg",
  authDomain: "draftorbit-web.firebaseapp.com",
  projectId: "draftorbit-web",
  storageBucket: "draftorbit-web.firebasestorage.app",
  messagingSenderId: "687122816959",
  appId: "1:687122816959:web:a495dc656f84f2e6b24b0a",
  measurementId: "G-7DTWGJQ4K9"
};
            if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
            const ADMIN_UID = "vSvd3m74q8ZWUsxoGpphKEnxkcH3";
            const db = firebase.firestore();

            // --- UI Elements ---
            const loadingState = document.getElementById('loading-state');
            const editorContainer = document.getElementById('invoice-editor-container');
            const projectNameEl = document.getElementById('project-name');
            const userNameEl = document.getElementById('user-name');
            const quotedPriceInput = document.getElementById('quoted-price');
            const extraDescInput = document.getElementById('extra-desc');
            const extraAmountInput = document.getElementById('extra-amount');
            const discountDescInput = document.getElementById('discount-desc');
            const discountAmountInput = document.getElementById('discount-amount');
            const finalTotalEl = document.getElementById('final-total');
            const notesInput = document.getElementById('invoice-notes');
            const saveButton = document.getElementById('save-invoice-button');
            const adminAlert = document.getElementById('admin-alert');

            const params = new URLSearchParams(window.location.search);
            const projectId = params.get('id');
            if (!projectId) { window.location.href = 'admin.html'; }

            let projectData;

            firebase.auth().onAuthStateChanged(user => {
                if (user && user.uid === ADMIN_UID) {
                    loadProjectData();
                } else {
                    window.location.href = 'admin-login.html';
                }
            });

            function loadProjectData() {
                db.collection('projects').doc(projectId).get().then(doc => {
                    if (doc.exists) {
                        projectData = doc.data();
                        projectNameEl.textContent = projectData.projectName;
                        userNameEl.textContent = projectData.userName;
                        quotedPriceInput.value = projectData.quotedPrice || 0;
                        
                        // If invoice data already exists, load it
                        if (projectData.invoiceDetails) {
                            extraDescInput.value = projectData.invoiceDetails.extraDesc || '';
                            extraAmountInput.value = projectData.invoiceDetails.extraAmount || 0;
                            discountDescInput.value = projectData.invoiceDetails.discountDesc || '';
                            discountAmountInput.value = projectData.invoiceDetails.discountAmount || 0;
                            notesInput.value = projectData.invoiceDetails.notes || '';
                        }
                        
                        calculateTotal();
                        loadingState.classList.add('d-none');
                        editorContainer.classList.remove('d-none');
                    }
                });
            }

            function calculateTotal() {
                const base = parseFloat(quotedPriceInput.value) || 0;
                const extra = parseFloat(extraAmountInput.value) || 0;
                const discount = parseFloat(discountAmountInput.value) || 0; // Should be negative
                const total = base + extra + discount;
                finalTotalEl.textContent = `₹${total.toFixed(2)}`;
            }

            // Add event listeners to auto-calculate
            [extraAmountInput, discountAmountInput].forEach(input => {
                input.addEventListener('input', calculateTotal);
            });

            saveButton.addEventListener('click', () => {
                saveButton.disabled = true;
                saveButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';

                const invoiceDetails = {
                    extraDesc: extraDescInput.value.trim(),
                    extraAmount: parseFloat(extraAmountInput.value) || 0,
                    discountDesc: discountDescInput.value.trim(),
                    discountAmount: parseFloat(discountAmountInput.value) || 0,
                    finalTotal: parseFloat(finalTotalEl.textContent.replace('₹', '')),
                    notes: notesInput.value.trim()
                };

                db.collection('projects').doc(projectId).update({
                    invoiceDetails: invoiceDetails,
                    invoiceEnabled: true // Enable the invoice for the customer
                }).then(() => {
                    showAlert('Invoice saved and enabled successfully!', 'success');
                    saveButton.textContent = 'Saved!';
                }).catch(error => {
                    showAlert('An error occurred. Please try again.', 'danger');
                    saveButton.disabled = false;
                    saveButton.textContent = 'Save & Enable Invoice for Customer';
                });
            });

            function showAlert(message, type = 'info') {
                adminAlert.textContent = message;
                adminAlert.className = `alert alert-${type} mt-3`;
                adminAlert.classList.remove('d-none');
            }
        });
    </script>
</body>
</html>