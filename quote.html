<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="assets/images/logo.png">
    <title>Instant Quote - DraftOrbit Studio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <div id="navbar-placeholder"></div>

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="text-center mb-5">
                    <h1 class="fw-bold">Instant 3D Printing Quote</h1>
                    <p class="lead text-muted">Upload your model, choose your options, and get an instant price estimate.</p>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4 p-md-5">
                        <fieldset id="quote-form-fieldset" disabled>
                            <div class="row">
                                <div class="col-md-6">
                                    <h5>1. Project & File</h5>
                                    <div class="mb-3">
                                        <label for="project-name" class="form-label">Project Name</label>
                                        <input type="text" class="form-control" id="project-name" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="file-upload" class="form-label">Upload your .stl file</label>
                                        <input class="form-control" type="file" id="file-upload" accept=".stl">
                                    </div>

                                    <h5 class="mt-4">2. Print Settings</h5>
                                    <div class="mb-3">
                                        <label for="material-select" class="form-label">Material</label>
                                        <select class="form-select" id="material-select">
                                            <option>Loading materials...</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="infill-slider" class="form-label">Infill Percentage: <span id="infill-value" class="fw-bold">20</span>%</label>
                                        <input type="range" class="form-range" id="infill-slider" min="10" max="100" step="5" value="20">
                                    </div>
                                    
                                    <div class="mb-3">
                                         <label for="quality-select" class="form-label">Print Quality</label>
                                         <select class="form-select" id="quality-select">
                                            <option value="standard" selected>Standard (0.2mm layers)</option>
                                            <option value="draft">Draft (0.28mm layers)</option>
                                            <option value="fine">Fine Detail (0.12mm layers)</option>
                                         </select>
                                    </div>
                                </div>
                                <div class="col-md-6 border-start">
                                    <h5 class="text-center">3. Your Instant Quote</h5>
                                    <div id="quote-results" class="text-center mt-4">
                                        <div class="spinner-border spinner-border-sm" role="status"></div>
                                        <p class="text-muted mt-2">Loading latest pricing...</p>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="footer-placeholder"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.124.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.124.0/examples/js/loaders/STLLoader.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="assets/js/assistant.js"></script> 
    
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const fieldset = document.getElementById('quote-form-fieldset');
            const fileUpload = document.getElementById('file-upload');
            const materialSelect = document.getElementById('material-select');
            const infillSlider = document.getElementById('infill-slider');
            const infillValueSpan = document.getElementById('infill-value');
            const qualitySelect = document.getElementById('quality-select');
            const quoteResultsDiv = document.getElementById('quote-results');
            const projectNameInput = document.getElementById('project-name');

            const db = firebase.firestore();
            let currentQuoteData = null;
            let livePricingData = null;

            async function loadPricingFromFirestore() {
                try {
                    const doc = await db.collection('settings').doc('pricing').get();
                    if (doc.exists) {
                        livePricingData = doc.data();
                        
                        materialSelect.innerHTML = '';
                        const sortedMaterials = Object.keys(livePricingData.materials).sort();
                        
                        sortedMaterials.forEach(key => {
                            const material = livePricingData.materials[key];
                            const option = document.createElement('option');
                            option.value = key;
                            option.textContent = material.name;
                            materialSelect.appendChild(option);
                        });

                        fieldset.disabled = false;
                        quoteResultsDiv.innerHTML = '<p class="text-muted">Fill out the details to see your price.</p>';
                    } else {
                        throw new Error("Pricing document not found.");
                    }
                } catch (error) {
                    console.error("Error fetching pricing:", error);
                    quoteResultsDiv.innerHTML = '<div class="alert alert-danger">Could not load pricing. Please try again later.</div>';
                }
            }
            
            function calculatePrice(volumeCm3, materialType, infillPercent, quality) {
                if (!livePricingData || !livePricingData.materials[materialType] || !livePricingData.qualityMultipliers) {
                    return { totalPrice: '0.00', volume: 0 };
                }

                const materialPricePerCm3 = livePricingData.materials[materialType].pricePerCubicCm;
                const baseFee = livePricingData.baseFee;
                const qualityMultiplier = livePricingData.qualityMultipliers[quality];

                const effectiveMaterialVolume = volumeCm3 * (infillPercent / 100);
                const materialCost = effectiveMaterialVolume * materialPricePerCm3;
                const timeAndComplexityCost = baseFee * qualityMultiplier;
                const totalPrice = materialCost + timeAndComplexityCost;
                
                return { 
                    totalPrice: totalPrice.toFixed(2), 
                    volume: Math.round(volumeCm3 * 100) / 100 
                };
            }

            async function saveOrderToFirestore() {
                const user = firebase.auth().currentUser;
                const orderButton = document.getElementById('proceed-to-order-button');

                if (!user) {
                    alert("Please log in to place an order.");
                    window.location.href = 'login.html';
                    return;
                }
                if (!currentQuoteData || !projectNameInput.value.trim()) {
                    alert("Please ensure you have a project name and a calculated quote.");
                    projectNameInput.focus();
                    return;
                }

                orderButton.disabled = true;
                orderButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Verifying Profile...';

                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (!userDoc.exists || !userDoc.data().fullName || !userDoc.data().addressLine1 || !userDoc.data().city) {
                        alert("Your billing address is incomplete. Please update your profile in 'My Account' before placing an order.");
                        orderButton.disabled = false;
                        orderButton.innerHTML = 'Proceed to Order';
                        return;
                    }
                    const userData = userDoc.data();

                    orderButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Placing Order...';

                    const billingDetails = {
                        fullName: userData.fullName,
                        phone: userData.phone || 'N/A',
                        addressLine1: userData.addressLine1,
                        addressLine2: userData.addressLine2 || '',
                        city: userData.city,
                        state: userData.state || '',
                        pincode: userData.pincode || ''
                    };
                    
                    const projectDescription = `Material: ${currentQuoteData.material.toUpperCase()}, Infill: ${currentQuoteData.infill}%, Quality: ${currentQuoteData.quality}, Volume: ${currentQuoteData.volume} cm³, Dimensions: ${currentQuoteData.dimensions}`;

                    const projectData = {
                        userId: user.uid,
                        userName: user.email,
                        userFullName: billingDetails.fullName,
                        projectName: projectNameInput.value.trim(),
                        fileName: currentQuoteData.fileName,
                        fileUrl: null,
                        projectDescription: projectDescription,
                        status: 'Quote Accepted',
                        quotedPrice: parseFloat(currentQuoteData.price),
                        submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        billingDetails: billingDetails
                    };

                    await db.collection('projects').add(projectData);
                    
                    alert("Your order has been placed successfully! You will now be redirected to your projects page.");
                    window.location.href = 'my-projects.html';

                } catch (error) {
                    console.error("Error placing order: ", error);
                    alert("An error occurred while placing your order. Please try again.");
                    orderButton.disabled = false;
                    orderButton.textContent = 'Proceed to Order';
                }
            }

            function runQuoteCalculation() {
                if (!livePricingData) return;

                const file = fileUpload.files[0];
                const material = materialSelect.value;
                const infill = parseInt(infillSlider.value);
                const quality = qualitySelect.value;

                if (!file) return;

                quoteResultsDiv.innerHTML = `<div class="spinner-border" role="status"></div><p class="mt-2 text-muted">Analyzing model...</p>`;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const loader = new THREE.STLLoader();
                        const geometry = loader.parse(event.target.result);
                        geometry.computeBoundingBox();
                        const box = geometry.boundingBox;
                        const width = (box.max.x - box.min.x).toFixed(1);
                        const depth = (box.max.y - box.min.y).toFixed(1);
                        const height = (box.max.z - box.min.z).toFixed(1);

                        // Robust volume calculation
                        let volume = 0;
                        const positions = geometry.attributes.position;
                        const p1 = new THREE.Vector3(), p2 = new THREE.Vector3(), p3 = new THREE.Vector3();
                        for (let i = 0; i < positions.count; i += 3) {
                            p1.fromBufferAttribute(positions, i);
                            p2.fromBufferAttribute(positions, i + 1);
                            p3.fromBufferAttribute(positions, i + 2);
                            volume += p1.dot(p2.cross(p3));
                        }
                        volume /= 6;
                        
                        const volumeCm3 = Math.abs(volume) / 1000;
                        
                        const priceDetails = calculatePrice(volumeCm3, material, infill, quality);

                        currentQuoteData = {
                            price: priceDetails.totalPrice, volume: priceDetails.volume,
                            dimensions: `${width} x ${depth} x ${height} mm`,
                            material: material, infill: infill, quality: quality,
                            fileName: file.name
                        };

                        const qualityText = quality.charAt(0).toUpperCase() + quality.slice(1);
                        const materialName = livePricingData.materials[material].name;
                        quoteResultsDiv.innerHTML = `
                            <h2 class="display-4 fw-bold text-primary">₹${priceDetails.totalPrice}</h2>
                            <p class="text-muted">Based on your selections</p><hr>
                            <ul class="list-unstyled text-start small">
                                <li><strong><i class="bi bi-palette-fill me-2"></i>Material:</strong> ${materialName}</li>
                                <li><strong><i class="bi bi-gear-wide-connected me-2"></i>Quality:</strong> ${qualityText}</li>
                                <li><strong><i class="bi bi-grid-3x3-gap-fill me-2"></i>Infill:</strong> ${infill}%</li>
                                <li><strong><i class="bi bi-box-seam me-2"></i>Model Volume:</strong> ${currentQuoteData.volume} cm³</li>
                                <li><strong><i class="bi bi-arrows-angle-expand me-2"></i>Dimensions:</strong> ${currentQuoteData.dimensions}</li>
                            </ul>
                            <div class="d-grid mt-3">
                                <button class="btn btn-success" id="proceed-to-order-button">Proceed to Order</button>
                            </div>
                        `;
                        document.getElementById('proceed-to-order-button').addEventListener('click', saveOrderToFirestore);
                    } catch (error) {
                        console.error("STL Parsing Error:", error);
                        quoteResultsDiv.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> Could not read the STL file. It may be corrupted.</div>`;
                    }
                };
                reader.readAsArrayBuffer(file);
            }
            
            infillSlider.addEventListener('input', () => {
                infillValueSpan.textContent = infillSlider.value;
                runQuoteCalculation();
            });
            qualitySelect.addEventListener('change', runQuoteCalculation);
            fileUpload.addEventListener('change', runQuoteCalculation);
            materialSelect.addEventListener('change', runQuoteCalculation);
            
            loadPricingFromFirestore();
        });
    </script>
</body>
</html>