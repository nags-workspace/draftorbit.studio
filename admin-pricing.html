<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="assets/images/logo.png">
    <title>Price Management - DraftOrbit Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>

    <nav class="navbar navbar-dark bg-dark navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand fw-bold" href="admin.html">DraftOrbit Admin</a>
            <div>
                <a href="admin.html" class="btn btn-outline-secondary">Back to Dashboard</a>
                <button class="btn btn-outline-light" id="logout-button">Logout</button>
            </div>
        </div>
    </nav>

    <main class="container py-5">
        <h1 class="fw-bold mb-4">Pricing & Materials Management</h1>
        <div id="admin-alert" class="alert d-none" role="alert"></div>

        <!-- General Settings Form -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header">General Settings</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="base-fee" class="form-label">Base Fee (INR)</label>
                        <div class="input-group">
                            <span class="input-group-text">₹</span>
                            <input type="number" class="form-control" id="base-fee" placeholder="e.g., 200" disabled>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">Print Quality Multipliers</label>
                        <div class="input-group">
                             <span class="input-group-text">Draft</span>
                             <input type="number" step="0.1" class="form-control" id="quality-draft" placeholder="e.g., 0.8" disabled>
                             <span class="input-group-text">Standard</span>
                             <input type="number" step="0.1" class="form-control" id="quality-standard" placeholder="e.g., 1.0" disabled>
                             <span class="input-group-text">Fine</span>
                             <input type="number" step="0.1" class="form-control" id="quality-fine" placeholder="e.g., 1.6" disabled>
                        </div>
                         <small class="form-text text-muted">These values multiply the Base Fee to account for print time. Standard should typically be 1.0.</small>
                    </div>
                </div>
                <div class="d-flex justify-content-end mt-3">
                    <button class="btn btn-secondary me-2 d-none" id="cancel-button">Cancel</button>
                    <button class="btn btn-primary d-none" id="save-button">Save Changes</button>
                    <button class="btn btn-primary" id="edit-button">Edit Settings</button>
                </div>
            </div>
        </div>

        <!-- Materials Management Table -->
        <div class="card border-0 shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                Materials
                <button class="btn btn-success btn-sm" id="add-material-button"><i class="bi bi-plus-circle-fill me-1"></i> Add New Material</button>
            </div>
            <div class="card-body">
                <table class="table align-middle">
                    <thead><tr><th>Name</th><th>Price per cm³ (INR)</th><th>Actions</th></tr></thead>
                    <tbody id="materials-table-body"></tbody>
                </table>
            </div>
        </div>
    </main>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyBEb1sB_AXKGxam3si8m81LPgr3b8HXTvg",
                authDomain: "draftorbit-web.firebaseapp.com",
                projectId: "draftorbit-web",
                storageBucket: "draftorbit-web.firebasestorage.app",
                messagingSenderId: "687122816959",
                appId: "1:687122816959:web:a495dc656f84f2e6b24b0a",
                measurementId: "G-7DTWGJQ4K9"
            };
            if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
            const ADMIN_UID = "vSvd3m74q8ZWUsxoGpphKEnxkcH3";
            const db = firebase.firestore();
            const pricingDocRef = db.collection('settings').doc('pricing');

            const baseFeeInput = document.getElementById('base-fee');
            const qualityDraftInput = document.getElementById('quality-draft');
            const qualityStandardInput = document.getElementById('quality-standard');
            const qualityFineInput = document.getElementById('quality-fine');
            
            const materialsTableBody = document.getElementById('materials-table-body');
            const addMaterialButton = document.getElementById('add-material-button');
            const adminAlert = document.getElementById('admin-alert');
            const logoutButton = document.getElementById('logout-button');
            const editButton = document.getElementById('edit-button');
            const saveButton = document.getElementById('save-button');
            const cancelButton = document.getElementById('cancel-button');

            const allSettingInputs = [baseFeeInput, qualityDraftInput, qualityStandardInput, qualityFineInput];
            let currentMaterials = {};

            firebase.auth().onAuthStateChanged(user => {
                if (!user || user.uid !== ADMIN_UID) {
                    window.location.href = 'admin-login.html';
                } else {
                    loadPricingData();
                }
            });

            logoutButton.addEventListener('click', () => firebase.auth().signOut().then(() => window.location.href = 'admin-login.html'));

            function setEditMode(isEditing) {
                allSettingInputs.forEach(input => input.disabled = !isEditing);
                editButton.classList.toggle('d-none', isEditing);
                saveButton.classList.toggle('d-none', !isEditing);
                cancelButton.classList.toggle('d-none', !isEditing);
            }

            function loadPricingData() {
                pricingDocRef.get().then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        baseFeeInput.value = data.baseFee || 0;
                        
                        if (data.qualityMultipliers) {
                            qualityDraftInput.value = data.qualityMultipliers.draft || 0.8;
                            qualityStandardInput.value = data.qualityMultipliers.standard || 1.0;
                            qualityFineInput.value = data.qualityMultipliers.fine || 1.6;
                        } else {
                            qualityDraftInput.value = 0.8;
                            qualityStandardInput.value = 1.0;
                            qualityFineInput.value = 1.6;
                        }
                        
                        currentMaterials = data.materials || {};
                        renderMaterialsTable();
                    }
                });
            }

            function renderMaterialsTable() {
                const sortedKeys = Object.keys(currentMaterials).sort();
                materialsTableBody.innerHTML = sortedKeys.length ? sortedKeys.map(key => {
                    const material = currentMaterials[key];
                    return `<tr><td>${material.name}</td><td>${material.pricePerCubicCm}</td><td><button class="btn btn-sm btn-outline-danger" onclick="deleteMaterial('${key}')">Delete</button></td></tr>`;
                }).join('') : '<tr><td colspan="3" class="text-center">No materials added yet.</td></tr>';
            }

            editButton.addEventListener('click', () => setEditMode(true));
            cancelButton.addEventListener('click', () => { loadPricingData(); setEditMode(false); });

            // --- THIS IS THE UPDATED SAVE FUNCTION ---
            saveButton.addEventListener('click', () => {
                const updatedData = {
                    baseFee: parseFloat(baseFeeInput.value) || 0,
                    qualityMultipliers: {
                        draft: parseFloat(qualityDraftInput.value) || 0.8,
                        standard: parseFloat(qualityStandardInput.value) || 1.0,
                        fine: parseFloat(qualityFineInput.value) || 1.6
                    }
                };

                // Use .set with { merge: true } to create or update fields without deleting others
                pricingDocRef.set(updatedData, { merge: true }).then(() => {
                    showAlert('General settings saved!', 'success');
                    setEditMode(false);
                }).catch(error => {
                    showAlert('Error saving settings: ' + error.message, 'danger');
                });
            });
            // --- END OF UPDATE ---

            addMaterialButton.addEventListener('click', () => {
                const name = prompt("Enter the material name (e.g., PLA, PETG):");
                if (!name || !name.trim()) return;
                const price = parseFloat(prompt(`Enter the price per cm³ for ${name}:`));
                if (isNaN(price)) { alert('Invalid price entered.'); return; }
                const key = name.toLowerCase().replace(/\s/g, '');
                currentMaterials[key] = { name: name.trim(), pricePerCubicCm: price };
                pricingDocRef.update({ materials: currentMaterials }).then(() => {
                    showAlert('Material added successfully!', 'success');
                    loadPricingData();
                });
            });
            
            window.deleteMaterial = (key) => {
                if (confirm(`Are you sure you want to delete ${currentMaterials[key].name}?`)) {
                    // To delete a field within a map, you need to use FieldValue.delete()
                    const updates = {};
                    updates[`materials.${key}`] = firebase.firestore.FieldValue.delete();
                    pricingDocRef.update(updates).then(() => {
                         showAlert('Material deleted.', 'warning');
                         loadPricingData();
                    });
                }
            }

            function showAlert(message, type = 'info') {
                adminAlert.textContent = message;
                adminAlert.className = `alert alert-${type}`;
                adminAlert.classList.remove('d-none');
                setTimeout(() => adminAlert.classList.add('d-none'), 4000);
            }
        });
    </script>
</body>
</html>