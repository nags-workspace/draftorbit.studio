<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="assets/images/logo.png">
    <title>Instant Quote - DraftOrbit Studio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <div id="navbar-placeholder"></div>

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="text-center mb-5">
                    <h1 class="fw-bold">Instant 3D Printing Quote</h1>
                    <p class="lead text-muted">Upload your model, choose your material, and get an instant price estimate.</p>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4 p-md-5">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>1. Name Your Project</h5>
                                <div class="mb-3">
                                    <label for="project-name" class="form-label">A unique name for your project</label>
                                    <input type="text" class="form-control" id="project-name" required>
                                </div>
                                
                                <h5 class="mt-4">2. Upload Your File</h5>
                                <div class="mb-3">
                                    <label for="file-upload" class="form-label">Supports .stl files</label>
                                    <input class="form-control" type="file" id="file-upload" accept=".stl">
                                </div>

                                <h5 class="mt-4">3. Choose Your Material</h5>
                                <div class="mb-3">
                                    <label for="material-select" class="form-label">Material</label>
                                    <select class="form-select" id="material-select">
                                        <option value="pla" selected>PLA</option>
                                        <option value="petg">PETG</option>
                                        <option value="abs">ABS</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6 border-start">
                                <h5 class="text-center">4. Your Instant Quote</h5>
                                <div id="quote-results" class="text-center mt-4">
                                    <p class="text-muted">Fill out the details to see your price.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="footer-placeholder"></div>

    <!-- ===== SCRIPTS ===== -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.124.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.124.0/examples/js/loaders/STLLoader.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/main.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- NEW: Add the assistant script here -->
    <script src="assets/js/assistant.js"></script> 
        <!-- ... all your HTML content and other script tags ... -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileUpload = document.getElementById('file-upload');
            const materialSelect = document.getElementById('material-select');
            const quoteResultsDiv = document.getElementById('quote-results');
            const projectNameInput = document.getElementById('project-name');

            const db = firebase.firestore();
            let currentQuoteData = null;

            const pricing = {
                pricePerCubicCm: { pla: 8, petg: 10, abs: 9 },
                baseFee: 200
            };

            function calculatePrice(volumeCm3, materialType) {
                const materialCost = volumeCm3 * pricing.pricePerCubicCm[materialType];
                const totalPrice = materialCost + pricing.baseFee;
                return { totalPrice: totalPrice.toFixed(2), volume: Math.round(volumeCm3 * 100) / 100 };
            }

            async function saveOrderToFirestore() {
                const user = firebase.auth().currentUser;
                const orderButton = document.getElementById('proceed-to-order-button');

                if (!user) {
                    alert("Please log in to place an order.");
                    window.location.href = 'login.html';
                    return;
                }
                if (!currentQuoteData || !projectNameInput.value.trim()) {
                    alert("Please ensure you have a project name and a calculated quote.");
                    projectNameInput.focus();
                    return;
                }

                orderButton.disabled = true;
                orderButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Verifying Profile...';

                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (!userDoc.exists || !userDoc.data().fullName || !userDoc.data().addressLine1 || !userDoc.data().city) {
                        alert("Your billing address is incomplete. Please update your profile in 'My Account' before placing an order.");
                        orderButton.disabled = false;
                        orderButton.innerHTML = 'Proceed to Order';
                        // Optionally, redirect them to the account page
                        // window.location.href = 'account.html';
                        return; // Stop the process
                    }
                    const userData = userDoc.data();

                    orderButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Placing Order...';

                    const billingDetails = {
                        fullName: userData.fullName,
                        phone: userData.phone || 'N/A',
                        addressLine1: userData.addressLine1,
                        addressLine2: userData.addressLine2 || '',
                        city: userData.city,
                        state: userData.state || '',
                        pincode: userData.pincode || ''
                    };

                    const projectData = {
                        userId: user.uid,
                        userName: user.email,
                        userFullName: billingDetails.fullName,
                        projectName: projectNameInput.value.trim(),
                        fileName: currentQuoteData.fileName,
                        fileUrl: null,
                        projectDescription: `Material: ${currentQuoteData.material.toUpperCase()}, Volume: ${currentQuoteData.volume} cmÂ³, Dimensions: ${currentQuoteData.dimensions}`,
                        status: 'Quote Accepted',
                        quotedPrice: parseFloat(currentQuoteData.price),
                        submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        billingDetails: billingDetails
                    };

                    await db.collection('projects').add(projectData);
                    
                    alert("Your order has been placed successfully! You will now be redirected to your projects page.");
                    window.location.href = 'my-projects.html';

                } catch (error) {
                    console.error("Error placing order: ", error);
                    alert("An error occurred while placing your order. Please try again.");
                    orderButton.disabled = false;
                    orderButton.textContent = 'Proceed to Order';
                }
            }

            function runQuoteCalculation() {
                const file = fileUpload.files[0];
                const material = materialSelect.value;
                if (!file) { return; }

                quoteResultsDiv.innerHTML = `<div class="spinner-border" role="status"></div><p class="mt-2 text-muted">Analyzing model...</p>`;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const loader = new THREE.STLLoader();
                        const geometry = loader.parse(event.target.result);
                        geometry.computeBoundingBox();
                        const box = geometry.boundingBox;
                        const width = (box.max.x - box.min.x).toFixed(1);
                        const depth = (box.max.y - box.min.y).toFixed(1);
                        const height = (box.max.z - box.min.z).toFixed(1);

                        let volume = 0;
                        const positions = geometry.attributes.position.array;
                        for (let i = 0; i < positions.length; i += 9) {
                            const p1 = new THREE.Vector3(positions[i], positions[i+1], positions[i+2]);
                            const p2 = new THREE.Vector3(positions[i+3], positions[i+4], positions[i+5]);
                            const p3 = new THREE.Vector3(positions[i+6], positions[i+7], positions[i+8]);
                            volume += p1.dot(p2.cross(p3)) / 6;
                        }
                        const volumeCm3 = Math.abs(volume) / 1000;
                        const priceDetails = calculatePrice(volumeCm3, material);

                        currentQuoteData = {
                            price: priceDetails.totalPrice,
                            volume: priceDetails.volume,
                            dimensions: `${width} x ${depth} x ${height} mm`,
                            material: material,
                            fileName: file.name
                        };

                        quoteResultsDiv.innerHTML = `
                            <h2 class="display-4 fw-bold text-primary">â¹${priceDetails.totalPrice}</h2>
                            <p class="text-muted">Based on your selections</p><hr>
                            <ul class="list-unstyled text-start">
                                <li><strong><i class="bi bi-arrows-angle-expand me-2"></i>Dimensions:</strong> ${currentQuoteData.dimensions}</li>
                                <li><strong><i class="bi bi-box-seam me-2"></i>Model Volume:</strong> ${currentQuoteData.volume} cmÂ³</li>
                            </ul>
                            <div class="d-grid mt-3">
                                <button class="btn btn-success" id="proceed-to-order-button">Proceed to Order</button>
                            </div>
                        `;
                        document.getElementById('proceed-to-order-button').addEventListener('click', saveOrderToFirestore);
                    } catch (error) {
                        quoteResultsDiv.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> Could not read the STL file. It may be corrupted.</div>`;
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            fileUpload.addEventListener('change', runQuoteCalculation);
            materialSelect.addEventListener('change', runQuoteCalculation);
        });
    </script>
</body>
</html>