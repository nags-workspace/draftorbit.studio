<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="assets/images/logo.png">
    <title>My Account - DraftOrbit Studio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <div id="navbar-placeholder"></div>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-7">
                <h2 class="mb-4 fw-bold">My Account</h2>
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <form id="account-form">
                            <h5 class="mb-3">Personal Details</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3"><label for="account-fullname" class="form-label">Full Name</label><input type="text" class="form-control" id="account-fullname" disabled></div>
                                <div class="col-md-6 mb-3"><label for="account-username" class="form-label">Username</label><input type="text" class="form-control" id="account-username" disabled></div>
                                <div class="col-md-6 mb-3"><label for="account-phone" class="form-label">Phone Number</label><input type="tel" class="form-control" id="account-phone" disabled></div>
                                <div class="col-md-6 mb-3"><label for="account-email" class="form-label">Email</label><input type="email" class="form-control-plaintext" id="account-email" readonly></div>
                            </div>
                            <hr class="my-4">
                            <h5 class="mb-3">Billing Address</h5>
                            <div class="mb-3"><label for="account-address1" class="form-label">Address Line 1</label><input type="text" class="form-control" id="account-address1" disabled></div>
                            <div class="mb-3"><label for="account-address2" class="form-label">Address Line 2 (Optional)</label><input type="text" class="form-control" id="account-address2" disabled></div>
                            <div class="row">
                                <div class="col-md-6 mb-3"><label for="account-city" class="form-label">City</label><input type="text" class="form-control" id="account-city" disabled></div>
                                <div class="col-md-6 mb-3"><label for="account-state" class="form-label">State</label><input type="text" class="form-control" id="account-state" disabled></div>
                                <div class="col-md-6 mb-3"><label for="account-pincode" class="form-label">Pincode</label><input type="text" class="form-control" id="account-pincode" disabled></div>
                            </div>
                            <div id="account-alert" class="alert d-none mt-3" role="alert"></div>
                            <div class="d-flex justify-content-end align-items-center mt-4">
                                <button type="button" class="btn btn-secondary me-2 d-none" id="cancel-button">Cancel</button>
                                <button type="submit" class="btn btn-primary d-none" id="save-button">Save Changes</button>
                                <button type="button" class="btn btn-primary" id="edit-button">Edit Profile</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="footer-placeholder"></div>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="assets/js/auth.js"></script>
    <script src="assets/js/main.js"></script>
    <!-- NEW: Add the assistant script here -->
    <script src="assets/js/assistant.js"></script> 
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const db = firebase.firestore();
            let currentUser = null;
            // Get references to ALL form elements
            const inputs = {
                fullName: document.getElementById('account-fullname'),
                username: document.getElementById('account-username'),
                phone: document.getElementById('account-phone'),
                email: document.getElementById('account-email'),
                address1: document.getElementById('account-address1'),
                address2: document.getElementById('account-address2'),
                city: document.getElementById('account-city'),
                state: document.getElementById('account-state'),
                pincode: document.getElementById('account-pincode'),
            };
            const editButton = document.getElementById('edit-button');
            const saveButton = document.getElementById('save-button');
            const cancelButton = document.getElementById('cancel-button');
            const accountAlert = document.getElementById('account-alert');
            const accountForm = document.getElementById('account-form');

            function setEditMode(isEditing) {
                // Loop through all inputs (except email) and toggle their disabled state
                Object.keys(inputs).forEach(key => { if(key !== 'email') inputs[key].disabled = !isEditing; });
                editButton.classList.toggle('d-none', isEditing);
                saveButton.classList.toggle('d-none', !isEditing);
                cancelButton.classList.toggle('d-none', !isEditing);
            }

            function loadUserProfile(uid) {
                db.collection('users').doc(uid).get().then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        inputs.fullName.value = data.fullName || '';
                        inputs.username.value = data.username || '';
                        inputs.phone.value = data.phone || '';
                        inputs.email.value = data.email || '';
                        inputs.address1.value = data.addressLine1 || '';
                        inputs.address2.value = data.addressLine2 || '';
                        inputs.city.value = data.city || '';
                        inputs.state.value = data.state || '';
                        inputs.pincode.value = data.pincode || '';
                    }
                });
            }

            firebase.auth().onAuthStateChanged(user => {
                if (user) { currentUser = user; loadUserProfile(user.uid); } 
                else { window.location.href = 'login.html'; }
            });

            editButton.addEventListener('click', () => setEditMode(true));
            cancelButton.addEventListener('click', () => { loadUserProfile(currentUser.uid); setEditMode(false); });

            accountForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const updatedData = {
                    fullName: inputs.fullName.value,
                    username: inputs.username.value,
                    phone: inputs.phone.value,
                    addressLine1: inputs.address1.value,
                    addressLine2: inputs.address2.value,
                    city: inputs.city.value,
                    state: inputs.state.value,
                    pincode: inputs.pincode.value,
                };
                db.collection('users').doc(currentUser.uid).update(updatedData).then(() => {
                    accountAlert.textContent = "Your profile has been updated successfully.";
                    accountAlert.className = 'alert alert-success mt-3';
                    setEditMode(false);
                }).catch(error => {
                    accountAlert.textContent = "An error occurred while updating.";
                    accountAlert.className = 'alert alert-danger mt-3';
                });
            });
        });
    </script>
</body>
</html>